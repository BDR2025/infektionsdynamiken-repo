<!doctype html>
<!--
  ============================================================================
  Project:  Understanding Infection Dynamics — Parameter-Tool · Demo-SVG
  Version:  v2.5.3  ·  Build: 2025-09-20
  License:  CC BY 4.0  ·  https://creativecommons.org/licenses/by/4.0/
  Author:   Nic + ChatGPT

  Zweck:
  - Vollständig selbst gezeichnetes SVG-Chart (KEINE Library), Y-Achse fest 0–100 %.
  - Keine Autoskalierung → keine "Unendlichkeit".
  - Werte werden vor dem Plotten normalisiert, geclamped und auf Finite geprüft.
  - Inklusive "Demo-Kopf" (Projekt-Annotation) wie in der Vorgängerversion.
  ============================================================================
-->
<html lang="de" data-mode="school" data-model="SIR" data-minilab-id="mlX">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Parameter-Tool · Demo-SVG (v2.5.3)</title>

  <!-- MathJax (für Formelansicht im Tool) -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['\\(','\\)'], ['$', '$']], packages: {'[+]': ['html']} },
      loader: { load: ['[tex]/html'] },
      options: { renderActions: { addMenu: [] } }
    };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

  <!-- Tool Styles (aus deinem /css/ Ordner) -->
  <link rel="stylesheet" href="css/parameter-tool.css">

  <style>
    :root{--bg:#0b1220;--panel:#0e1628;--border:#1f2a3d;--text:#e5e7eb;--muted:#9aa7bd;--accent:#6aa0ff}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:24px auto;padding:16px}

    /* --- Demo-Kopf (Projekt-Annotation) --- */
    .head{border:1px solid var(--border);border-radius:12px;background:var(--panel);padding:14px;margin-bottom:12px}
    .head h1{font-size:18px;margin:0 0 12px}
    .head .muted{color:var(--muted);font-weight:400}
    .meta{display:grid;grid-template-columns: 1fr 2fr;gap:8px 16px;font-size:.92rem}
    .meta div{padding:2px 0}
    .meta .k{color:var(--muted)}
    .links a{color:#9ec0ff;text-decoration:none}
    .links a:hover{text-decoration:underline}

    /* --- Bar über dem Tool --- */
    .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:12px 0}
    .bar label{font-size:.9rem;color:var(--muted)}
    .bar select,.bar button{height:34px;padding:0 10px;border:1px solid var(--border);border-radius:8px;background:#0f1a2e;color:var(--text)}
    .tabs{display:inline-flex;border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .tabs button{background:#0f1a2e;border:0;padding:8px 12px;color:var(--text);cursor:pointer}
    .tabs button[aria-pressed="true"]{background:#132545}

    /* --- Karten / Layout --- */
    .card{border:1px solid var(--border);border-radius:12px;background:var(--panel);padding:14px}
    .hint{font-size:.85rem;color:var(--muted)}
    .grid{display:grid;gap:12px;grid-template-columns: 2fr 1fr}
    @media (max-width: 980px){ .grid{grid-template-columns: 1fr} }

    /* --- SVG Microchart --- */
    .svg-card{border:1px solid var(--border);border-radius:12px;background:#0d1830;padding:12px}
    .svg-wrap{position:relative;width:100%;height:240px}
    .svg-wrap svg{position:absolute;inset:0;width:100%;height:100%}
    .svg-legend{display:flex;gap:10px;align-items:center;margin:6px 0 0}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:#0f1a2e;color:var(--text);font-size:.8rem}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent)}
    .dot-r{background:#e0e0e0}
    .axis-label{font-size:11px;fill:#b7c3d9}
    .gridline{stroke:#24314a;stroke-width:1}
    .path-I{fill:none;stroke:#a8c6ff;stroke-width:2}
    .path-R0{fill:none;stroke:#c9c9c9;stroke-width:1.5;stroke-dasharray:6 4}
    .path-Re{fill:none;stroke:#ffffff;stroke-width:1.5;stroke-dasharray:2 4}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Demo-Kopf / Projekt-Annotation -->
    <section class="head" aria-labelledby="hdr">
      <h1 id="hdr">Parameter-Tool · Standalone <span class="muted">— Demo &amp; Formel-Ansicht</span></h1>
      <div class="meta">
        <div class="k">Projekt / Project</div><div>Infektionsdynamiken verstehen · Understanding Infection Dynamics</div>
        <div class="k">Modul / Module</div><div>Parameter-Tool (Standalone, University-Mode Formel-Ansicht)</div>
        <div class="k">Version</div><div>v2.5.3 · Build 2025-09-20</div>
        <div class="k">Autoren / Authors</div><div>Boris Dominic Rausch · Prof. Dr. Andreas Heinz</div>
        <div class="k">Kontakt / Contact</div><div>info@infektionsdynamiken.de · info@infectiondynamics.eu</div>
        <div class="k">Repository</div><div class="links"><a href="https://infektionsdynamiken.de/repo/" target="_blank" rel="noopener">infektionsdynamiken.de/repo/</a></div>
        <div class="k">Dokumentation</div><div class="links"><a href="#" title="Technische Dokumentation (Markdown)">Technische Dokumentation (markdown)</a> · <a href="#" title="Scrum/Epic Dokumentation (PDF)">Scrum/Epic Dokumentation (PDF)</a></div>
        <div class="k">Lizenz / License</div><div class="links"><a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">CC BY 4.0 — creativecommons.org/licenses/by/4.0/</a></div>
      </div>
    </section>

    <!-- Steuerleiste (Modell/Modus/Ansicht) -->
    <div class="card bar" id="demo-bar" role="region" aria-label="Demo-Steuerung">
      <label for="sel-model">Modell</label>
      <select id="sel-model" aria-label="Modell">
        <option value="SIR">SIR</option>
        <option value="SEIR">SEIR</option>
        <option value="SIS">SIS</option>
        <option value="SIRD">SIRD</option>
        <option value="SIRV">SIRV</option>
      </select>

      <label for="sel-mode">Modus</label>
      <select id="sel-mode" aria-label="Modus">
        <option value="school">School</option>
        <option value="university" selected>University</option>
      </select>

      <div class="tabs" role="tablist" aria-label="Ansicht">
        <button id="tab-regler" type="button" role="tab" aria-selected="false" aria-pressed="false">Regler-Ansicht</button>
        <button id="tab-formel" type="button" role="tab" aria-selected="true" aria-pressed="true">Formel-Ansicht</button>
      </div>

      <button id="btn-reset" type="button" title="Standardwerte setzen">Reset</button>
      <span class="hint">v2.5.3 · Demo-SVG fixiert Y 0–100 %</span>
    </div>

    <div class="grid">
	  <div class="svg-card">
        <div class="hint" style="margin-bottom:6px">Demo-Chart (SVG, I(t) als % von N, Y fest 0–100 %)</div>
        <div class="svg-wrap" id="svgHost"></div>
        <div class="svg-legend">
          <span class="badge"><span class="dot"></span>I(t) [% von N]</span>
          <span class="badge"><span class="dot dot-r"></span>R₀ / Rₑff(0) (Skala 0–10)</span>
        </div>
      </div>
      <div class="card">
        <!-- Mount-Container für das Parameter-Tool -->
        <div id="parameter-tool" class="pt" data-pt-formula="true"></div>
      </div>
    </div>
  </div>

  <!-- Tool core (aus deinem /js/ Ordner) -->
  <script defer src="js/parameter-tool.js"></script>

  <script>
  (function(){
    const $ = (s, r=document)=>r.querySelector(s);
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,Number(v)));
    const isF = (x)=>Number.isFinite(x);

    const html = document.documentElement;
    html.setAttribute('data-model', html.getAttribute('data-model') || 'SIR');
    html.setAttribute('data-mode',  html.getAttribute('data-mode')  || 'university');

    function mountTool(){
      if (!window.ParameterTool || typeof window.ParameterTool.mount !== 'function') return;
      try { window.ParameterTool.mount({ target: '#parameter-tool' }); }
      catch(e){ console.warn('[Demo-SVG] mount failed', e); }
    }

    // --- Minimal-SVG-Chart ------------------------------------------------
    function createSvg(host){
      const svgNS = 'http://www.w3.org/2000/svg';
      const svg = document.createElementNS(svgNS, 'svg');

      // Gruppen: Grid, Paths, Labels
      const gGrid = document.createElementNS(svgNS, 'g');
      const gPaths = document.createElementNS(svgNS, 'g');
      const gLabels = document.createElementNS(svgNS, 'g');

      // Pfade
      const pI  = document.createElementNS(svgNS, 'path'); pI.setAttribute('class','path-I');
      const pR0 = document.createElementNS(svgNS, 'path'); pR0.setAttribute('class','path-R0');
      const pRe = document.createElementNS(svgNS, 'path'); pRe.setAttribute('class','path-Re');

      gPaths.appendChild(pI); gPaths.appendChild(pR0); gPaths.appendChild(pRe);
      svg.appendChild(gGrid); svg.appendChild(gPaths); svg.appendChild(gLabels);
      host.innerHTML=''; host.appendChild(svg);

      return { svg, gGrid, gPaths, gLabels, pI, pR0, pRe };
    }

    function sizeOf(el){
      const r = el.getBoundingClientRect();
      const w = Math.max(100, Math.floor(r.width));
      const h = Math.max(80,  Math.floor(r.height));
      return {w,h};
    }

    function buildGrid(gGrid, gLabels, w, h, pad, yTicks, xTicks){
      gGrid.innerHTML = ''; gLabels.innerHTML = '';
      const svgNS = 'http://www.w3.org/2000/svg';

      // Y: 0..100 %
      yTicks.forEach(v=>{
        const y = pad.top + (1 - (v/100)) * (h - pad.top - pad.bottom);
        const line = document.createElementNS(svgNS,'line');
        line.setAttribute('x1', pad.left); line.setAttribute('x2', w - pad.right);
        line.setAttribute('y1', y);        line.setAttribute('y2', y);
        line.setAttribute('class','gridline');
        gGrid.appendChild(line);

        const lbl = document.createElementNS(svgNS,'text');
        lbl.setAttribute('x', 6);
        lbl.setAttribute('y', y - 2);
        lbl.setAttribute('class','axis-label');
        lbl.textContent = v + ' %';
        gLabels.appendChild(lbl);
      });

      // Y2: 0..10 (nur Label rechts, keine Extra-Linien)
      const y2lbl = document.createElementNS(svgNS,'text');
      y2lbl.setAttribute('x', w - pad.right + 4);
      y2lbl.setAttribute('y', pad.top + 12);
      y2lbl.setAttribute('class','axis-label');
      y2lbl.textContent = 'R (0–10)';
      gLabels.appendChild(y2lbl);

      // X: 0..T Tage (0, Mitte, Ende)
      xTicks.forEach(obj=>{
        const x = pad.left + obj.pos * (w - pad.left - pad.right);
        const lbl = document.createElementNS(svgNS,'text');
        lbl.setAttribute('x', x);
        lbl.setAttribute('y', h - 4);
        lbl.setAttribute('text-anchor','middle');
        lbl.setAttribute('class','axis-label');
        lbl.textContent = obj.text;
        gLabels.appendChild(lbl);
      });
    }

    function pathFromSeries(series, w, h, pad, yMin, yMax){
      // Sanitize + Clamp (verhindert NaN/Infinity)
      const a = series.map(v=> (isF(v)? v : null));
      const innerW = w - pad.left - pad.right;
      const innerH = h - pad.top  - pad.bottom;
      if (innerW <= 0 || innerH <= 0 || a.length === 0) return '';

      const n = a.length;
      const ySpan = (yMax - yMin) || 1;

      let d = '';
      let started = false;

      for (let i=0;i<n;i++){
        const raw = a[i];
        if (!isF(raw)) { started = false; continue; }
        const v = clamp(raw, yMin, yMax);
        const x = pad.left + (n===1 ? 0 : (i/(n-1))*innerW);
        const y = pad.top  + (1 - (v - yMin)/ySpan) * innerH;
        if (!isF(x) || !isF(y)) { started=false; continue; }
        d += (started ? ' L ' : ' M ') + x.toFixed(2) + ' ' + y.toFixed(2);
        started = true;
      }
      return d;
    }

    // Zeitreihe generieren (stabil, bounded) → I% von N; R0/Reff0 auf 0..10 gekappt
    function buildSeries(state){
      const p = (state && state.params)  || {};
      const d = (state && state.derived) || {};

      const N  = clamp(p.N ?? 1_000_000, 1, 1e12);
      const T  = clamp(p.T ?? 60,         10, 365);
      const dt = clamp(p.dt ?? 1,         0.05, 2);

      // I0 klein halten (Demo)
      const I0 = clamp(p.I0 ?? 1, 1, Math.max(1, N*0.01));

      // gamma: aus p.gamma oder 1/D
      let gamma = Number(p.gamma);
      if (!isF(gamma) || gamma <= 0) {
        const D = Number(p.D);
        gamma = (isF(D) && D > 0) ? (1 / D) : 0.1;
      }
      gamma = clamp(gamma, 1e-6, 2);

      // Reff0 & R0
      const Reff0 = isF(d.Reff0) ? d.Reff0 : 1;
      const R0    = isF(d.R0   ) ? d.R0    : (isF(p.R0) ? p.R0 : 1);

      // r clampen
      let r = gamma * (Reff0 - 1);
      if (!isF(r)) r = 0;
      r = clamp(r, -2, 2);

      const steps = Math.max(5, Math.min(800, Math.round(T / dt)));
      const xs = [];
      const Ipct = [];
      const R0s  = [];
      const Res  = [];

      let I = I0;
      let t = 0;

      for (let k=0; k<=steps; k++){
        xs.push(t);
        const Ii = Math.max(0, Math.min(N, I));
        const pct = (Ii / N) * 100;
        Ipct.push(isF(pct) ? clamp(pct, 0, 100) : 0);
        R0s.push( clamp(isF(R0)?R0:0,  0, 10) );
        Res.push( clamp(isF(Reff0)?Reff0:0, 0, 10) );

        // logistischer Schritt (bounded, verhindert Divergenz)
        const dI = r * I * (1 - I / N) * dt;
        I = I + dI;
        if (!isF(I)) I = N;

        // optionaler Frühabbruch bei starkem Rückgang
        if (I < 1e-9 && r <= 0) {
          for (let j=k+1; j<=steps; j++){
            xs.push(t + dt*(j-k));
            Ipct.push(0);
            R0s.push(R0s[0]);
            Res.push(Res[0]);
          }
          break;
        }
        t += dt;
      }

      // Downsampling (max ~400 Punkte, stabil)
      const maxPts = 400;
      if (Ipct.length > maxPts){
        const ratio = Ipct.length / maxPts;
        const pick = (arr) => arr.filter((_,i)=> Math.floor(i/ratio) === i/ratio);
        return { xs: pick(xs), Ipct: pick(Ipct), R0s: pick(R0s), Res: pick(Res) };
      }
      return { xs, Ipct, R0s, Res };
    }

    // Rendering + Resize
    const svgHost = $('#svgHost');
    let svgRefs = null;
    let rafPending = false;

    function renderSvg(){
      if (!svgHost) return;
      if (!svgRefs) svgRefs = createSvg(svgHost);

      const { svg, gGrid, gLabels, pI, pR0, pRe } = svgRefs;
      const { w, h } = sizeOf(svgHost);
      svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
      svg.setAttribute('width', w);
      svg.setAttribute('height', h);

      const pad = { left: 42, right: 42, top: 12, bottom: 20 };

      // Grid & Labels
      buildGrid(gGrid, gLabels, w, h, pad,
        [0,25,50,75,100],
        [{pos:0, text:'0 d'},{pos:0.5, text:'T/2'},{pos:1, text:'T'}]
      );

      // Daten holen & Pfade bauen
      let st = null;
      try { st = window.ParameterTool ? window.ParameterTool.getState() : null; } catch(_e){}
      const series = buildSeries(st || {});

      const dI  = pathFromSeries(series.Ipct, w, h, pad, 0, 100);
      const dR0 = pathFromSeries(series.R0s,  w, h, pad, 0, 10);
      const dRe = pathFromSeries(series.Res,  w, h, pad, 0, 10);

      pI.setAttribute('d',  dI || 'M 0 '+(h-pad.bottom));
      pR0.setAttribute('d', dR0 || 'M 0 '+(h-pad.bottom));
      pRe.setAttribute('d', dRe || 'M 0 '+(h-pad.bottom));
    }

    function requestRender(){
      if (rafPending) return;
      rafPending = true;
      requestAnimationFrame(()=>{ rafPending = false; renderSvg(); });
    }

    // --- Wiring ----------------------------------------------------------
    document.addEventListener('DOMContentLoaded', function(){
      mountTool();

      const selModel = $('#sel-model');
      const selMode  = $('#sel-mode');
      const tabReg   = $('#tab-regler');
      const tabFor   = $('#tab-formel');
      const hostTool = $('#parameter-tool');

      if (selModel) selModel.value = (html.getAttribute('data-model') || 'SIR').toUpperCase();
      if (selMode)  selMode.value  = (html.getAttribute('data-mode')  || 'university').toLowerCase();

      // Tool-Events → render (breit gefächert, um verschiedene Inkrements abzudecken)
      document.addEventListener('idv:params:ready',  requestRender);
      document.addEventListener('idv:params:update', requestRender);
      document.addEventListener('idv:param:change',  requestRender);
      document.addEventListener('idv:model:update',  requestRender);

      // Model/Mode Switch
      if (selModel) selModel.addEventListener('change', function(){
        const model = this.value.toUpperCase();
        html.setAttribute('data-model', model);
        if (window.ParameterTool && typeof window.ParameterTool.set === 'function') {
          try { window.ParameterTool.set({ meta:{ model } }); } catch(_e){}
        }
        requestRender();
      });
      if (selMode) selMode.addEventListener('change', function(){
        const mode = this.value.toLowerCase();
        html.setAttribute('data-mode', mode);
        if (window.ParameterTool && typeof window.ParameterTool.set === 'function') {
          try { window.ParameterTool.set({ meta:{ mode } }); } catch(_e){}
        }
        requestRender();
      });

      // Ansicht: Regler/Formel (wir setzen Attribut + versuchen freundlich das Tool zu informieren)
      function setFormulaView(on){
        if (!hostTool) return;
        hostTool.dataset.ptFormula = String(!!on);
        tabReg.setAttribute('aria-pressed', String(!on));
        tabReg.setAttribute('aria-selected', String(!on));
        tabFor.setAttribute('aria-pressed', String(on));
        tabFor.setAttribute('aria-selected', String(on));
        if (window.ParameterTool && typeof window.ParameterTool.set === 'function') {
          try { window.ParameterTool.set({ meta:{ view: on?'formula':'controls' } }); } catch(_e){}
        }
        requestRender();
      }
      tabReg?.addEventListener('click', ()=> setFormulaView(false));
      tabFor?.addEventListener('click', ()=> setFormulaView(true));

      // Reset
      const btnReset = $('#btn-reset');
      if (btnReset) btnReset.addEventListener('click', function(){
        const model = (selModel?.value||'SIR').toUpperCase();
        const mode  = (selMode?.value ||'university').toLowerCase();
        html.setAttribute('data-model', model);
        html.setAttribute('data-mode',  mode);
        if (window.ParameterTool && typeof window.ParameterTool.set === 'function') {
          try { window.ParameterTool.set({ meta:{ model, mode }, params:{} }); } catch(_e){}
        }
        requestRender();
      });

      // Initial + Resize
      setFormulaView(true);  // Start in der Formel-Ansicht, wie im Screenshot
      requestRender();
      window.addEventListener('resize', requestRender, { passive:true });
    });
  })();
  </script>
</body>
</html>
